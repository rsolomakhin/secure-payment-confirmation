<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title> Payment Method: Secure Payment Confirmation </title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove">
  </script>
  <script class='remove'>
    // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
    const respecConfig = {
      editors: [{
        name: "Rouslan Solomakhin",
        company: "Google",
      }],
      github: "w3c/secure-payment-confirmation",
      group: "payments",
      shortName: "secure-payment-confirmation",
      specStatus: "ED",
      xref: "web-platform",
    };
  </script>
</head>

<body>
  <section id="abstract">
    <p>This specification describes data structures, formats, algorithms, and
      processing models to facilitate [[webauthn-3]] based payments on the Web.
      It is used by other specifications.</p>
  </section>
  <section id="sotd">
    <p>This is a work in progress.</p>
  </section>
  <section id="introduction">
    <h2>Introduction</h2>
    <p>This specification defines dictionaries and
      "<a>secure-payment-confirmation</a>" payment method for use, for instance,
      with [[webauthn-3]] and [[payment-request]]. With it, merchants can
      request a signature over transaction details to be verified by the issuing
      bank.</p>
    <p>This specification describes two flows: enrollment and payment
      authorization.</p>
    <p>This specification relies on the use of the {{PublicKeyCredential}} from
      [[webauthn-3]].</p>
  </section>
  <section id="enrollment">
    <h2>Enrollment</h2>
    <p>To enroll a new payment instrument, relying parties can use
      <code>navigator.credentials.create()</code>, which must display a prompt
      to the user.</p>
    <section id="enrollment-input">
      <h3>Input for Enrollment</h3>
      <p>The following sections describe the input data structures for creating
        a credential for payments.</p>
      <section data-dfn-for="CredentialCreationOptions">
        <h4>Monkey Patch for [[webauthn-3]] <dfn>CredentialCreationOptions</dfn>
          Dictionary</h4>
        <pre class="idl">
        dictionary CredentialCreationOptions {
          PaymentCredentialCreationOptions payment;
        };
        </pre>
        <p>This specification monkey-patches the [[webauthn-3]] dictionary
          {{CredentialCreationOptions}} with one additional member:</p>
        <dl>
          <dt><dfn>payment</dfn> member</dt>
          <dd>The parameters for enrollment of a new {{PublicKeyCredential}} as
            defined in [[webauthn-3]] for payments.</dd>
        </dl>
      </section>
      <section data-dfn-for="PaymentCredentialCreationOptions">
        <h4><dfn>PaymentCredentialCreationOptions</dfn> Dictionary</h4>
        <pre class="idl">
        dictionary PaymentCredentialCreationOptions {
          required PublicKeyCredentialRpEntity rp;
          required sequence&lt;PublicKeyCredentialParameters&gt; pubKeyCredParams;
          required BufferSource challenge;
          required PaymentCredentialInstrument instrument;
          unsigned long timeout;
        };
        </pre>
        <p> The {{PaymentCredentialCreationOptions}} dictionary contains the
          [[webauthn-3]] {{PublicKeyCredentialRpEntity}} and
          {{PublicKeyCredentialParameters}} (as well as the
          <code>challenge</code> and <code>timeout</code> fields) for creating a
          {{PublicKeyCredential}}.</p>
        <dl>
          <dt><dfn>rp</dfn> member</dt>
          <dd>The information about the relying party, as defined in
            [[webauthn-3]]. </dd>
          <dt><dfn>pubKeyCredParams</dfn> member</dt>
          <dd>The parameters for creating the {{PublicKeyCredential}} as defined
            in [[webauthn-3]].</dd>
          <dt><dfn>challenge</dfn> member</dt>
          <dd>A random one-time challenge that the relying party typically
            generated on the server side to prevent replay attacks.</dd>
          <dt><dfn>instrument</dfn> member</dt>
          <dd>The instrument information to display during enrollment.</dd>
          <dt><dfn>timeout</dfn> member</dt>
          <dd>The number of milliseconds before the request to create the
            credential times out. At most 1 hour.</dd>
        </dl>
      </section>
    </section>
    <section id="enrollment-output">
      <h3>Output of Enrollment</h3>
      <p>If the <code>payment</code> parameter is specified in
        <code>navigator.credentials.create()</code> and the creation of a
        [[webauthn-3]] {{PublicKeyCredential}} is successful, then the user
        agent must output a {{PublicKeyCredential}} with:</p>
      <ul>
        <li><code>type</code> set to "<code>payment</code>".</li>
        <li><code>response.clientDataJson.type</code> set to
          "<code>payment.create</code>".</li>
      </ul>
    </section>
  </section>
  <section id="payment-authorization">
    <h2>Payment Authorization</h2>
    <p>To sign over transaction details, create a new {{PaymentRequest}} object
      as described in [[payment-request]] with a single {{PaymentMethodData}},
      no <code>displayItems</code>, and no <code>options</code>. Set the
      {{PaymentMethodData}}<code>.supportedMethods</code> to
      "<a>secure-payment-confirmation</a>" and set
      {{PaymentMethodData}}<code>.data</code> to
      {{SecurePaymentConfirmationRequest}}.</p>
    <p>Calling {{PaymentRequest}}<code>.show()</code> must prompt the user to
      confirm the transaction details.</p>
    <section id="method-id">
      <h3>Payment Method Identifier</h3>
      <p>The [[payment-request]] uses a [=payment method identifier=] from
        [[payment-method-id]] to identify a payment flow. The [=standardized
        payment method identifier=] for this specification is
        "<dfn>secure-payment-confirmation</dfn>". </p>
    </section>
    <section id="payment-authorizationn-input">
      <h3>Input for Payment Authorization</h3>
      <p>The following section describes the input data structure for signing
        over transaction details.</p>
      <section data-dfn-for="SecurePaymentConfirmationRequest">
        <h3><dfn>SecurePaymentConfirmationRequest</dfn> Dictionary</h3>
        <pre class="idl">
        dictionary SecurePaymentConfirmationRequest {
          required BufferSource challenge;
          required FrozenArray&lt;BufferSource&gt; credentialIds;
          required PaymentCredentialInstrument instrument;
          unsigned long timeout;
        };
        </pre>
        <p>The {{SecurePaymentConfirmationRequest}} dictionary contains the
          following members:</p>
        <dl>
          <dt><dfn>challenge</dfn> member</dt>
          <dd>A random one-time challenge that the relying party generates on
            the server side to prevent replay attacks.</dd>
          <dt><dfn>credentialIds</dfn> member</dt>
          <dd>The list of credential identifiers for the given instrument.</dd>
          <dt><dfn>instrument</dfn> member</dt>
          <dd>The description of the instrument name and icon to display during
            enrollment and to be signed along with the transaction details.
          </dd>
          <dt><dfn>timeout</dfn> member</dt>
          <dd>The number of milliseconds before the request to sign the
            transaction details times out. At most 1 hour.</dd>
        </dl>
      </section>
    </section>
    <section id="payment-authorization-output">
      <h3>Output of Payment Authorization</h3>
      <p>The output of a successful payment authorization is a
        [[payment-request]] {{PaymentResponse}} with:</p>
      <ul>
        <li><code>methodName</code> set to "<a>secure-payment-confirmation</a>".
        </li>
        <li><code>details</code> set to the [[webauthn-3]]
          {{PublicKeyCredential}}.</li>
        <li><code>details.type</code> set to "<code>payment</code>".</li>
        <li>{{CollectedClientPaymentData}} in the
          <code>details.response.clientDataJson</code> field.</li>
        <li><code>details.response.clientDataJson.type</code> set to
          "<code>payment.get</code>".</li>
      </ul>
      <section data-dfn-for="CollectedClientPaymentData">
        <h4><dfn>CollectedClientPaymentData</dfn> Dictionary</h4>
        <pre class="idl">
        dictionary CollectedClientPaymentData : CollectedClientData {
          required CollectedClientAdditionalPaymentData payment;
        };
        </pre>
        <p>The {{CollectedClientPaymentData}} dictionary inherits from
          {{CollectedClientData}} from [[webauthn-3]] with <code>type</code>
          field always set to "<code>payment.get</code>". It contains the
          following additional field:</p>
        <dl>
          <dt><dfn>payment</dfn> member</dt>
          <dd>The additional payment information to sign.</dd>
        </dl>
      </section>
      <section data-dfn-for="CollectedClientAdditionalPaymentData">
        <h4><dfn>CollectedClientAdditionalPaymentData</dfn> Dictionary</h4>
        <pre class="idl">
        dictionary CollectedClientAdditionalPaymentData {
          required USVString rp;
          required USVString topOrigin;
          required PaymentCurrencyAmount total;
          required PaymentCredentialInstrument instrument;
        };
        </pre>
        <p>The {{CollectedClientAdditionalPaymentData}} dictionary contains the
          following fields:</p>
        <dl>
          <dt><dfn>rp</dfn> member</dt>
          <dd>The relying party that created the credential.</dd>
          <dt><dfn>topOrigin</dfn> member</dt>
          <dd>The origin of the top level context that requested to sign the
            transaction details. Typically this would be called a merchant.
          </dd>
          <dt><dfn>total</dfn> member</dt>
          <dd>The {{PaymentCurrencyAmount}} of the [[payment-request]]
            <code>total</code> field.</dd>
          <dt><dfn>instrument</dfn> member</dt>
          <dd>The instrument information that was displayed to the user.</dd>
        </dl>
        <p>Note that there is no <code>paymentRequestOrigin</code> field in
          {{CollectedClientAdditionalPaymentData}}, because the origin of the
          iframe is already included in {{CollectedClientData}} of
          [[webauthn-3]].</p>
      </section>
    </section>
  </section>
  <section id="common-data-structure">
    <h2>Common Data Structure</h2>
    <p>The following data structure is shared between enrollment and payment
      authorization.</p>
    <section data-dfn-for="PaymentCredentialInstrument">
      <h3><dfn>PaymentCredentialInstrument</dfn> Dictionary</h3>
      <pre class="idl">
      dictionary PaymentCredentialInstrument {
        required DOMString displayName;
        required USVString icon;
      };
      </pre>
      <p>The {{PaymentCredentialInstrument}} dictionary contains the information
        to be displayed to the user and signed together with the transaction
        details. It contains the following members:</p>
      <dl>
        <dt><dfn>displayName</dfn> member</dt>
        <dd>The name of the payment instrument to be displayed to the user.
        </dd>
        <dt><dfn>icon</dfn> member</dt>
        <dd>The URL of the icon of the payment instrument.</dd>
      </dl>
    </section>
  </section>
</body>

</html>
